# Quickstart — Creating a Magic Scripts Command

A complete walkthrough of building and publishing your first Magic Scripts command (pack).
Based on the real development flow used to build `portcheck`.

---

## Prerequisites

- `ms` installed (see [User Quickstart](../user-guide/00-QUICKSTART.md))
- A GitHub repository created for your command (e.g. `github.com/magic-scripts/portcheck`)
- git configured locally

---

## 1. Scaffold the project

```sh
ms pub pack init portcheck \
  --description "Check and manage processes using specific ports" \
  --author "Your Name" \
  --email "you@example.com" \
  --license "MIT" \
  --category "utilities"
```

This creates the full project structure:

```
portcheck/
├── scripts/portcheck.sh      ← your command implementation
├── registry/
│   ├── portcheck.mspack      ← package metadata
│   └── portcheck.msver       ← version list
├── installer/
│   ├── install.sh            ← post-install hook
│   └── uninstall.sh          ← pre-uninstall hook
├── man/portcheck.1           ← man page
├── README.md
├── LICENSE
└── .gitignore
```

Git is initialized automatically with `main` and `develop` branches.

> **Branch strategy:**
> - `develop` — active development (dev releases served from here)
> - `main` — stable, holds the version list (`msver`)
> - `release/v*` — immutable reference point for each release

---

## 2. Implement the script

Move into the project directory and edit `scripts/portcheck.sh`:

```sh
cd portcheck
```

**Required conventions:**

```sh
#!/bin/sh          # POSIX sh — not bash
VERSION="0.1.0"

# --help and --version must be supported
case "$1" in
    --help|-h)    show_help; exit 0 ;;
    --version|-v) printf "%s v%s\n" "$SCRIPT_NAME" "$VERSION"; exit 0 ;;
esac
```

> **POSIX rules:** Avoid `[[ ]]`, `BASH_REMATCH`, and process substitution `<(...)`.
> Use `[`, `case`/`sed`, and `mktemp` instead.

Test locally while developing:

```sh
sh scripts/portcheck.sh --version
sh scripts/portcheck.sh --help
sh scripts/portcheck.sh 3000
```

---

## 3. Understand the generated registry files

`registry/portcheck.msver` (generated by init):

```
version|dev|https://raw.githubusercontent.com/magic-scripts/portcheck/develop/scripts/portcheck.sh|dev|...
```

The `dev` entry points directly at the `develop` branch. Once you push, anyone can install the development version.

`registry/portcheck.mspack` points the version list at `main`:

```
msver_url|https://raw.githubusercontent.com/magic-scripts/portcheck/main/registry/portcheck.msver
```

This means the stable version list is always read from `main`, while dev script downloads come from `develop`.

---

## 4. Verify the registry files

```sh
ms pub pack verify registry/
```

Expected output:
```
Verifying registry files in registry/...
  portcheck.mspack ... OK
  portcheck.msver  ... OK
All checks passed.
```

---

## 5. Push to GitHub

```sh
git remote add origin https://github.com/magic-scripts/portcheck.git
git push -u origin main develop
```

The `develop` branch is now live and the dev version is installable.

---

## 6. Register in the master registry

Add an entry to `ms/registry/ms.msreg`:

```
portcheck|https://raw.githubusercontent.com/magic-scripts/portcheck/main/registry/portcheck.mspack|Check and manage processes using specific ports|utilities
```

---

## 7. Test the full install flow

```sh
ms install portcheck
portcheck --version
portcheck --help
```

---

## 8. Cut a release (v0.1.0)

Once development is complete, run the release from the `develop` branch:

```sh
ms pub pack release registry/ 0.1.0 --push
```

This single command:

1. Validates registry files
2. Calculates the script checksum
3. Creates a `release/v0.1.0` branch with rewritten URLs
4. Merges into `main`
5. Syncs `develop` from `main`
6. Pushes all branches

After release, `registry/portcheck.msver` contains both entries:

```
version|dev|.../develop/scripts/portcheck.sh|dev|...
version|0.1.0|.../release/v0.1.0/scripts/portcheck.sh|a1b2c3d4|...
```

---

## File reference

| File | Purpose |
|------|---------|
| `scripts/<name>.sh` | Command implementation |
| `registry/<name>.mspack` | Package metadata and msver URL |
| `registry/<name>.msver` | Version history and download URLs |
| `installer/install.sh` | Hook run after installation |
| `installer/uninstall.sh` | Hook run before removal |
| `man/<name>.1` | Man page |

---

## Next steps

- [02-CREATING_COMMANDS.md](02-CREATING_COMMANDS.md) — in-depth command authoring guide
- [03-PUBLISHING.md](03-PUBLISHING.md) — versioning and release workflow
- [04-REGISTRY.md](04-REGISTRY.md) — registry system internals
